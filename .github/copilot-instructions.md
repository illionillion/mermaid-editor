# GitHub Copilot カスタムインストラクション

このドキュメントは、GitHub Copilot がローカルや GitHub 上でのレビュー、コード生成などを行う際に参照するためのカスタムインストラクションです。

## 基本ルール

1. **応答言語**: 質問への回答は常に日本語で行ってください。
2. **確認メッセージ**: ルールを参照したことを示すため、回答の冒頭に「ルールを参照しました！」と表示してください。
3. **テスト実行の効率化と検証**: 明確に変更したファイルがある場合は、まずテスト内容が修正内容を正しく検証できるかを確認してから、`pnpm test:run`で全体を実行するのではなく単体で実行して時間を省略する（例: `pnpm test:run features/er-diagram/__tests__/import-mermaid-to-er.test.ts`）。必要に応じてテストケースを追加してから実行する。詳細な手法は `TESTING.md` の実践的ベストプラクティスを参照。
4. **PRレビューコメント確認**: PR上でCopilotのレビューを確認する際は`gh api url/comments`でコメントを確認し、GitHubのWeb UIではなくCLIで効率的に対応する
5. **コード品質の基本**: ファイル冒頭のimport文セクションに機能修正のコードを混在させない、配列などの`{}`の開始終了を明確にする、ソースコードが壊れないように注意する
6. **型安全性の徹底**: any禁止、型安全に実装する
7. **JSDocコメントの徹底**: 関数と定数にコメントを書く場合は必ずJSDoc形式を使用する。インラインコメントではなく、`/**...*/`形式で詳細な説明・例・制約を記載する
8. **コミット粒度の細分化**: 複数ファイルをまとめてaddしてコミットするのではなく、論理的に関連する変更ごとに小分けしてコミットする。1つのコミットは1つの明確な目的を持つようにし、レビューしやすい粒度に保つ。具体的には `git add 特定ファイル` → `git commit` を繰り返し、一度に複数の無関係な変更をコミットしない
9. **PR作成の最適化**: テンプレートに従いつつ、Copilotがレビューしやすいよう重点レビュー箇所を明記する。変更の意図・影響範囲・テスト方針を具体的に記載し、レビュー効率を向上させる
10. **ルール管理**: 重要なベストプラクティスを発見した際は、基本ルールへの昇格も検討し、動的ルールセクションまたは基本ルールへの追加を提案する

## ディレクトリ構造の理解

### `/app`

- App Routerのルーティング

### `/components`

- 再利用可能なUIコンポーネント
- 共通的なものを配置

### `/features`

- bulletproof-reactの構造を参考にした機能ごとのディレクトリ
- 機能ごとのコードを配置
  - 各機能は独立しており、再利用可能なコンポーネントを含む
  - components・hooks・stories・types・**tests**を含む

### `/docs`

- ビルド後のファイルを配置
- GitHub Pagesで公開

### `/public`

- 静的ファイルを配置

### `__test__/e2e`

- エンドツーエンドテストを配置
- Playwrightを使用

### `__image_snapshots__`

- VRTの画像スナップショットを配置

### `.github`

- GitHub関連の設定ファイルを配置

## 開発フロー

以下は機能開発からデプロイまでの一連のフローです：

1. 該当Issueに「着手開始」コメントを記載
2. `main`ブランチから新しいブランチを作成、変更内容が分かる命名（`ラベル/issue番号-内容`）にする
3. 開発作業を実施
   - `CONTRIBUTING.md`と`DEVELOPMENT.md`に従って作業を進める
   - 基本ルールに従ってコード品質と型安全性を保つ
4. 動作確認・セルフレビューの実施
   - テスト`pnpm test:run`を実行し、すべてのテストが通ることを確認する
5. Pull Request の作成
   - タイトル: 変更内容を簡潔に表現（プレフィックス不要）
   - 説明文: プロジェクトのテンプレートに従う
   - Commit Message: README のルールに従う
   - Assignees に自分を設定（Reviewers は任意）
   - テンプレートに従って作成する
   - `Closes issue`を書く
6. レビューを受ける
7. 修正が必要な場合は対応する
8. 繰り返す
9. 1 つ以上の Approve を得たらマージ
10. IssueをCloseする

## 自動ルール管理

このセクションは、開発中に発見されたベストプラクティスや注意点を自動的に蓄積する実験的機能です。

### 仕組み

- レビューコメントや開発中に発見された重要なルールが自動的に記録される
- ルールは具体的で再現可能な形で記述される
- 日付と関連コンテキストが併記される

### 動的ルール

<!-- AUTO_RULES_START: このコメント間のルールは自動管理されます -->

#### 型安全性・テスト設計

- **公式仕様準拠の重要性** (2024-09-27)
  - Mermaid記法の正規表現は公式仕様に厳密に従う
  - 空白を含む型名（例: DECIMAL(10, 2)）は公式Mermaidでエラーとなるため、非対応とする
  - テストケースも公式仕様に準拠させ、実際に動作しない記法はテストしない

- **ラベル正規化処理の可読性** (2024-09-27)
  - 文字列処理ロジックは単一の複雑な処理ではなく、関数として分離する
  - 各処理の目的と理由を詳細なコメントで説明する
  - 正規表現のパターンは変数として抽出し、意図を明確にする

#### コメント・ドキュメント品質

- **JSDoc形式の統一徹底** (2024-09-27)
  - 関数・定数には必ずJSDoc形式（`/**...*/`）でコメントを記載
  - インラインコメント（`//`）よりもJSDocを優先し、`@description`、`@example`、`@param`、`@returns`を活用
  - 正規表現や複雑なロジックは具体例と制約を明記
  - 定数は用途・フォールバック理由・関連仕様を説明

- **インラインコメントの禁止** (2025-10-05)
  - 変数・定数・条件分岐の説明に`/** ... */`形式のインラインコメントを使用しない
  - すべてのコメントはJSDoc形式（`/**...*/`）で、対象要素の直前に配置する
  - 詳細な説明・例・制約をJSDoc形式で記載し、一行コメントは避ける
  - 条件分岐やロジックの説明もJSDoc形式のブロックコメントで記載する

  **Good:**

  ```typescript
  /**
   * エッジのユニークID生成用カウンター
   * @description 各エッジに一意のIDを付与するためのインクリメンタルカウンター
   * @example "edge-0", "edge-1", "edge-2"...
   * @rationale 同じテーブル間に複数のリレーションがある場合でも重複を避けるため
   */
  let edgeCounter = 0;

  /**
   * ノード定義の解析
   * @description テーブル定義ブロックの開始を検出し、テーブル名とカラム定義を抽出
   * @pattern /^[\w-]+\s*\{/ ハイフンを含むテーブル名もサポート
   * @example "User {", "LINE-ITEM {", "DELIVERY-ADDRESS {"
   */
  if (/^[\w-]+\s*\{/.test(line)) {
  ```

  **Bad:**

  ```typescript
  let edgeCounter = 0; /** エッジのユニークID生成用カウンター */

  /** ノード定義（ハイフンを含むテーブル名もサポート：LINE-ITEM, DELIVERY-ADDRESS等） */
  if (/^[\w-]+\s*\{/.test(line)) {

  id: `edge-${edgeCounter++}` /** ユニークなIDを生成 */,
  ```

#### テスト品質

- **テストベストプラクティス準拠** (2025-10-07)
  - 修正内容の事前検証、UIアニメーション対応、公式仕様準拠など詳細は `TESTING.md` の実践的ベストプラクティスセクションを参照
  - 正規表現修正時は必ず対応するテストケースを事前に追加
  - CI環境での安定性を考慮し `findByRole` でアニメーション完了を待機
  - 異常系・境界値・エッジケース・国際化対応を含む包括的なテスト設計

<!-- AUTO_RULES_END -->
